<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ·˜å®¢å¤©ä¸‹è”åˆå‘è¿è¿å•ç®¡ç†ç³»ç»Ÿ - æ§åˆ¶å°</title>
    <link rel="stylesheet" href="/static/styles/main.css">
    <link rel="icon" href="data:,">
</head>
<body>
{% raw %}
<div id="app" v-cloak>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <img src="/pictures/TK Logo.png" class="brand-logo" alt="Logo">
                <div>
                    <div class="brand-text-main">æ·˜å®¢å¤©ä¸‹è”åˆå‘è¿</div>
                    <div class="brand-text-sub">è¿å•ç®¡ç†ç³»ç»Ÿæ§åˆ¶å°</div>
                </div>
            </div>

            <div class="menu-section-title">å¯¼èˆªèœå•</div>
            <nav class="menu">
                <div class="menu-group" v-for="menu in filteredMenus" :key="menu.id">
                    <router-link
                        v-if="!menu.children || menu.children.length === 0"
                        :to="menu.path"
                        class="menu-item"
                    >
                        <div class="menu-item-left">
                            <div class="menu-dot"></div>
                            <span>{{ menu.title }}</span>
                        </div>
                    </router-link>
                    
                    <div
                        v-else
                        class="menu-item"
                        :class="{ 'router-link-active': isMenuActive(menu) }"
                        @click="toggleExpand(menu)"
                    >
                        <div class="menu-item-left">
                            <div class="menu-dot"></div>
                            <span>{{ menu.title }}</span>
                        </div>
                        <div class="menu-arrow">
                            <span v-if="isExpanded(menu)">â–¾</span>
                            <span v-else>â–¸</span>
                        </div>
                    </div>

                    <transition name="collapse">
                        <div
                            v-if="menu.children && menu.children.length && isExpanded(menu)"
                            class="submenu"
                        >
                            <router-link
                                v-for="child in menu.children"
                                :key="child.id"
                                :to="child.path"
                                class="submenu-item"
                            >
                                {{ child.title }}
                            </router-link>
                        </div>
                    </transition>
                </div>
            </nav>

            <div class="sidebar-footer">
                å½“å‰è§’è‰²ï¼š
                <span class="sidebar-role-tag">ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆæ‹¥æœ‰æ‰€æœ‰é¡µé¢æƒé™ï¼‰</span>
            </div>
        </aside>

        <main class="content">
            <header class="topbar">
                <div class="topbar-title">æ·˜å®¢å¤©ä¸‹è”åˆå‘è¿è¿å•ç®¡ç†ç³»ç»Ÿ</div>
                <div class="topbar-user">
                    <div class="topbar-user-info" @click.stop="toggleUserMenu">
                        <span>å½“å‰ç”¨æˆ·ï¼š</span>
                        <span class="topbar-user-name">{{ currentUser.username }}</span>
                        <span class="topbar-user-role">{{ currentUser.role }}</span>
                        <span class="topbar-user-arrow">â–¼</span>
                    </div>
                    
                    <div v-show="showUserMenu" class="user-dropdown">
                        <button class="user-dropdown-item" @click="showChangePasswordModal">
                            <span>ğŸ”‘</span>
                            <span>ä¿®æ”¹å¯†ç </span>
                        </button>
                        <div class="user-dropdown-divider"></div>
                        <button class="user-dropdown-item danger" @click="logout">
                            <span>ğŸšº</span>
                            <span>é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
            </header>

            <section class="content-inner">
                <router-view></router-view>
            </section>
        </main>
    </div>
    
    <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
    <div v-if="showPasswordModal" class="modal-overlay" @click.self="closePasswordModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">ä¿®æ”¹å¯†ç </h3>
                <button class="modal-close" @click="closePasswordModal">&times;</button>
            </div>
            
            <form @submit.prevent="submitPasswordChange" class="modal-body">
                <div class="form-field" style="margin-bottom: 16px;">
                    <label>æ—§å¯†ç  <span style="color: #e57373;">*</span></label>
                    <input
                        type="password"
                        class="form-input"
                        v-model.trim="passwordForm.oldPassword"
                        placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
                        autocomplete="current-password"
                    />
                    <div v-if="passwordErrors.oldPassword" class="error-text">{{ passwordErrors.oldPassword }}</div>
                </div>
                
                <div class="form-field" style="margin-bottom: 16px;">
                    <label>æ–°å¯†ç  <span style="color: #e57373;">*</span></label>
                    <input
                        type="password"
                        class="form-input"
                        v-model.trim="passwordForm.newPassword"
                        placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
                        autocomplete="new-password"
                    />
                    <div v-if="passwordErrors.newPassword" class="error-text">{{ passwordErrors.newPassword }}</div>
                </div>
                
                <div class="form-field" style="margin-bottom: 16px;">
                    <label>ç¡®è®¤æ–°å¯†ç  <span style="color: #e57373;">*</span></label>
                    <input
                        type="password"
                        class="form-input"
                        v-model.trim="passwordForm.confirmPassword"
                        placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
                        autocomplete="new-password"
                    />
                    <div v-if="passwordErrors.confirmPassword" class="error-text">{{ passwordErrors.confirmPassword }}</div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="closePasswordModal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" :disabled="passwordSubmitting">
                        <span v-if="!passwordSubmitting">ç¡®è®¤ä¿®æ”¹</span>
                        <span v-else>ä¿®æ”¹ä¸­...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endraw %}

<script type="text/template" id="initial-data">
    {{ user | tojson }}
</script>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/vue-router@4/dist/vue-router.global.prod.js"></script>
<script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="/static/components/PlaceholderPage.js"></script>
<script src="/static/components/DashboardPage.js"></script>
<script src="/static/components/RoleManagePage.js"></script>
<script src="/static/components/UserManagePage.js"></script>
<script src="/static/components/CountryManagePage.js"></script>
<script src="/static/components/ProductManagePage.js"></script>
<script src="/static/components/CustomerManagePage.js"></script>
<script src="/static/components/SupplierManagePage.js"></script>
<script src="/static/components/CustomerQuoteManagePage.js"></script>
<script src="/static/components/SupplierQuoteManagePage.js"></script>
<script src="/static/components/WaybillManagePage.js"></script>
<script src="/static/components/ReceivableInvoicePage.js"></script>
<script src="/static/components/PayableInvoicePage.js"></script>
<script src="/static/components/PaymentManagePage.js"></script>
<script>
    const initialUser = JSON.parse(document.getElementById('initial-data').textContent);
    const { createApp } = Vue;
    const { createRouter, createWebHashHistory } = VueRouter;

    // è·¯ç”±é…ç½®
    const routes = [
        { path: "/", redirect: "/dashboard" },
        { path: "/dashboard", component: DashboardPage, meta: { title: "ä»ªè¡¨ç›˜" } },
        { path: "/basic/role", component: RoleManagePage, meta: { title: "è§’è‰²ç®¡ç†" } },
        { path: "/basic/user", component: UserManagePage, meta: { title: "ç”¨æˆ·ç®¡ç†" } },
        { path: "/basic/country", component: CountryManagePage, meta: { title: "ç›®çš„å›½ç®¡ç†" } },
        { path: "/basic/product", component: ProductManagePage, meta: { title: "äº§å“ç®¡ç†" } },
        { path: "/basic/customer", component: CustomerManagePage, meta: { title: "å®¢æˆ·ç®¡ç†" } },
        { path: "/basic/supplier", component: SupplierManagePage, meta: { title: "ä¾›åº”å•†ç®¡ç†" } },
        { path: "/waybill", component: WaybillManagePage, meta: { title: "è¿å•æ•°æ®ç®¡ç†" } },
        { path: "/finance/ar-bill", component: ReceivableInvoicePage, meta: { title: "åº”æ”¶è´¦å•ç®¡ç†" } },
        { path: "/finance/ap-bill", component: PayableInvoicePage, meta: { title: "åº”ä»˜è´¦å•ç®¡ç†" } },
        { path: "/finance/payment", component: PaymentManagePage, meta: { title: "æ”¶ä»˜æ¬¾ç®¡ç†" } },
        { path: "/finance/customer-quote", component: CustomerQuoteManagePage, meta: { title: "å®¢æˆ·æŠ¥ä»·ç®¡ç†" } },
        { path: "/finance/supplier-quote", component: SupplierQuoteManagePage, meta: { title: "ä¾›åº”å•†æŠ¥ä»·ç®¡ç†" } },
    ];

    const router = createRouter({
        history: createWebHashHistory(),
        routes,
    });

    // èœå•é…ç½®
    const menus = [
        { id: "dashboard", title: "ä»ªè¡¨ç›˜", path: "/dashboard", children: [] },
        {
            id: "basic",
            title: "åŸºç¡€èµ„æ–™ç®¡ç†",
            children: [
                { id: "role", title: "è§’è‰²ç®¡ç†", path: "/basic/role" },
                { id: "user", title: "ç”¨æˆ·ç®¡ç†", path: "/basic/user" },
                { id: "country", title: "ç›®çš„å›½ç®¡ç†", path: "/basic/country" },
                { id: "product", title: "äº§å“ç®¡ç†", path: "/basic/product" },
                { id: "customer", title: "å®¢æˆ·ç®¡ç†", path: "/basic/customer" },
                { id: "supplier", title: "ä¾›åº”å•†ç®¡ç†", path: "/basic/supplier" },
            ],
        },
        { id: "waybill", title: "è¿å•æ•°æ®ç®¡ç†", path: "/waybill", children: [] },
        {
            id: "finance",
            title: "è´¢åŠ¡ç®¡ç†",
            children: [
                { id: "ar-bill", title: "åº”æ”¶è´¦å•ç®¡ç†", path: "/finance/ar-bill" },
                { id: "ap-bill", title: "åº”ä»˜è´¦å•ç®¡ç†", path: "/finance/ap-bill" },
                { id: "payment", title: "æ”¶ä»˜æ¬¾ç®¡ç†", path: "/finance/payment" },
                { id: "customer-quote", title: "å®¢æˆ·æŠ¥ä»·ç®¡ç†", path: "/finance/customer-quote" },
                { id: "supplier-quote", title: "ä¾›åº”å•†æŠ¥ä»·ç®¡ç†", path: "/finance/supplier-quote" },
            ],
        },
    ];

    const app = createApp({
        data() {
            return {
                currentUser: initialUser,
                menus,
                expandedIds: ["basic", "finance"],
                showUserMenu: false,
                showPasswordModal: false,
                passwordForm: {
                    oldPassword: "",
                    newPassword: "",
                    confirmPassword: "",
                },
                passwordErrors: {
                    oldPassword: "",
                    newPassword: "",
                    confirmPassword: "",
                },
                passwordSubmitting: false,
                userPermissions: null,  // ç”¨æˆ·æƒé™
                visibleMenus: [],  // å¯è§çš„èœå•
            };
        },
        async mounted() {
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼Œä¸å…³é—­
                if (!e.target.closest('.topbar-user')) {
                    this.showUserMenu = false;
                }
            });
            
            // åŠ è½½ç”¨æˆ·æƒé™
            await this.loadUserPermissions();
        },
        computed: {
            filteredMenus() {
                if (!this.userPermissions) {
                    return [];
                }
                
                // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºæ‰€æœ‰èœå•
                if (this.userPermissions.permissions === 'ALL') {
                    return this.menus;
                }
                
                // æ ¹æ®æƒé™è¿‡æ»¤èœå•
                const permMap = {};
                this.userPermissions.pages.forEach(p => {
                    permMap[p.page_key] = p;
                });
                
                const filtered = [];
                this.menus.forEach(menu => {
                    if (!menu.children || menu.children.length === 0) {
                        // ä¸€çº§èœå•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ can_view æƒé™
                        const menuKey = this.getMenuKey(menu.path);
                        if (permMap[menuKey] && permMap[menuKey].can_view) {
                            filtered.push(menu);
                        }
                    } else {
                        // æœ‰å­èœå•ï¼Œè¿‡æ»¤å­èœå•
                        const visibleChildren = menu.children.filter(child => {
                            const childKey = this.getMenuKey(child.path);
                            return permMap[childKey] && permMap[childKey].can_view;
                        });
                        
                        if (visibleChildren.length > 0) {
                            filtered.push({
                                ...menu,
                                children: visibleChildren
                            });
                        }
                    }
                });
                
                return filtered;
            }
        },
        methods: {
            async loadUserPermissions() {
                try {
                    const res = await fetch('/api/user-permissions');
                    const data = await res.json();
                    if (data.success) {
                        this.userPermissions = data;
                    }
                } catch (e) {
                    console.error('åŠ è½½ç”¨æˆ·æƒé™å¤±è´¥', e);
                }
            },
            getMenuKey(path) {
                // å°†è·¯å¾„è½¬æ¢ä¸º page_key
                // /dashboard -> dashboard
                // /basic/role -> basic.role
                // /waybill -> waybill.main
                const pathMap = {
                    '/dashboard': 'dashboard',
                    '/basic/role': 'basic.role',
                    '/basic/user': 'basic.user',
                    '/basic/country': 'basic.country',
                    '/basic/product': 'basic.product',
                    '/basic/customer': 'basic.customer',
                    '/basic/supplier': 'basic.supplier',
                    '/waybill': 'waybill.main',
                    '/finance/ar-bill': 'finance.ar_bill',
                    '/finance/ap-bill': 'finance.ap_bill',
                    '/finance/payment': 'finance.payment',
                    '/finance/customer-quote': 'finance.customer_quote',
                    '/finance/supplier-quote': 'finance.supplier_quote',
                };
                return pathMap[path] || '';
            },
            isExpanded(menu) {
                return this.expandedIds.includes(menu.id);
            },
            toggleExpand(menu) {
                if (!menu.children || !menu.children.length) return;
                const idx = this.expandedIds.indexOf(menu.id);
                if (idx >= 0) {
                    this.expandedIds.splice(idx, 1);
                } else {
                    this.expandedIds.push(menu.id);
                }
            },
            isMenuActive(menu) {
                if (!menu.children || !menu.children.length) return false;
                const currentPath = this.$route.path;
                return menu.children.some(child => child.path === currentPath);
            },
            toggleUserMenu() {
                this.showUserMenu = !this.showUserMenu;
            },
            showChangePasswordModal() {
                this.showUserMenu = false;
                this.showPasswordModal = true;
                this.resetPasswordForm();
            },
            closePasswordModal() {
                this.showPasswordModal = false;
                this.resetPasswordForm();
            },
            resetPasswordForm() {
                this.passwordForm = {
                    oldPassword: "",
                    newPassword: "",
                    confirmPassword: "",
                };
                this.passwordErrors = {
                    oldPassword: "",
                    newPassword: "",
                    confirmPassword: "",
                };
            },
            validatePasswordForm() {
                this.passwordErrors = {
                    oldPassword: "",
                    newPassword: "",
                    confirmPassword: "",
                };
                
                let isValid = true;
                
                if (!this.passwordForm.oldPassword) {
                    this.passwordErrors.oldPassword = "è¯·è¾“å…¥å½“å‰å¯†ç ";
                    isValid = false;
                }
                
                if (!this.passwordForm.newPassword) {
                    this.passwordErrors.newPassword = "è¯·è¾“å…¥æ–°å¯†ç ";
                    isValid = false;
                } else if (this.passwordForm.newPassword.length < 6) {
                    this.passwordErrors.newPassword = "å¯†ç é•¿åº¦è‡³å°‘6ä½";
                    isValid = false;
                }
                
                if (!this.passwordForm.confirmPassword) {
                    this.passwordErrors.confirmPassword = "è¯·ç¡®è®¤æ–°å¯†ç ";
                    isValid = false;
                } else if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
                    this.passwordErrors.confirmPassword = "ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´";
                    isValid = false;
                }
                
                return isValid;
            },
            async submitPasswordChange() {
                if (!this.validatePasswordForm()) {
                    return;
                }
                
                this.passwordSubmitting = true;
                
                try {
                    const res = await fetch("/api/change-password", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            oldPassword: this.passwordForm.oldPassword,
                            newPassword: this.passwordForm.newPassword,
                        }),
                    });
                    
                    const data = await res.json().catch(() => ({}));
                    
                    if (!res.ok || !data.success) {
                        if (data.field) {
                            this.passwordErrors[data.field] = data.message;
                        } else {
                            alert(data.message || "ä¿®æ”¹å¯†ç å¤±è´¥");
                        }
                        return;
                    }
                    
                    alert("å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•");
                    this.closePasswordModal();
                    
                    // é€€å‡ºç™»å½•
                    setTimeout(() => {
                        fetch('/api/logout', { method: 'POST' })
                            .finally(() => {
                                window.location.href = '/login';
                            });
                    }, 500);
                    
                } catch (e) {
                    alert("ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
                } finally {
                    this.passwordSubmitting = false;
                }
            },
            logout() {
                if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    return;
                }
                this.showUserMenu = false;
                fetch('/api/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login';
                    })
                    .catch(() => {
                        window.location.href = '/login';
                    });
            },
        },
    });

    app.use(router);
    app.mount("#app");
</script>
</body>
</html>
